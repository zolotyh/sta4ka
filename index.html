<!doctype html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

		<title>Рефакторинг</title>

		<link rel="stylesheet" href="css/reveal.css">
		<link rel="stylesheet" href="css/theme/white.css">

		<!-- Theme used for syntax highlighting of code -->
		<link rel="stylesheet" href="lib/css/zenburn.css">

		<!-- Printing and PDF exports -->
		<script>
			var link = document.createElement( 'link' );
			link.rel = 'stylesheet';
			link.type = 'text/css';
			link.href = window.location.search.match( /print-pdf/gi ) ? 'css/print/pdf.css' : 'css/print/paper.css';
			document.getElementsByTagName( 'head' )[0].appendChild( link );
		</script>
	</head>
	<body>
		<div class="reveal">
			<div class="slides">
          <section>
              <h3>
                  Как привести в порядок миллион строк клиентского кода за неделю и не сойти с ума 
              </h3>
              <p>
                  Алексей Золотых, Wrike
              </p>
              <aside class="notes">
                  Не все могут смотреть в завтрашний день
              </aside>
          </section>
          <section>
            <img src="img/wrike.com.png" alt="">
          </section>
          <section>
              <h2>Про нас</h2>
              <ul>
                  <li class="fragment">
                      2 000 000 строк кода
                  </li>
                  <li class="fragment">
                       Измененные библиотеки под VCS
                  </li>
                  <li class="fragment">
                      50 разработчиков, которые постоянно пишут фичи
                  </li>
                  <li class="fragment">
                      В коде много глобальных переменных
                  </li>
              </ul>
          </section>
					<section data-background-image="img/2.jpg" data-background-color="#322F26">
              <aside class="notes">
                  Рудольф Клаузиус 
              </aside>
          </section>
					<section>
              <h3>
                  Рудольф Клаузиус 
              </h3>
              <p>
                  1822 &mdash; 1888
              </p>
          </section>
					<section>
              <h3 class="fragment1" data-fragment-index="0">
                  Второе начало термодинамики
              </h3>
              <p class="fragment" data-fragment-index="1">Закон неубывания энтропии</p>
          </section>
          <section>
              Если в некоторый момент времени замкнутая система находится в неравновесном макроскопическом состоянии, то в последующие моменты времени наиболее вероятным следствием будет монотонное возрастание её энтропии.
          </section>
          <section data-background-image="img/3.gif" data-background-color="#322F26" >
          </section>
          <section>
              Если не наводить порядок, то код будет запутываться
          </section>
          <section  data-background-video="img/3.mp4"></section>
          <section>
              <b>Рефа́кторинг</b> &mdash; процесс изменения внутренней структуры программы, <b>не затрагивающий её внешнего поведения </b> и имеющий целью облегчить понимание её работы и также другие бла бла бла, которые никто никогда не читает
          </section>
          <section>
            <img src="img/condom.png" alt="">
            <h2>Живи полной жизнью</h2>
            <aside class="notes">
              Рефакторинг в каком-то смысле защита, инвестиция в будующее
              С ним ощущения не те <br>
              Да я успею отрефакторить после релиза <br>
            </aside>
          </section>
					<section>
							<h2>Рефакторить фронтенд сложно</h2>
					</section>
          <section>
						<h2>Основные причины</h2>
						<ul>
								<li>Минимум 3 контекста:<br>
										html, css, js <span class="fragment">, less, stylus, typescript, jade, jsx</span>
								</li>
								<li class="fragment">Контексты плохо связаны между собой</li>
						</ul>
				</section>
        <section data-background-video="img/csside.mov">
           <aside class="notes">
            <p>Удобно добавлять префикс js- для классов, которые использует javascript</p>
           </aside>
        </section>
        <section>
          <h1>Острожно!</h1>
          <p>Не стоит все писать на JS, это может навредить вашему фронтенду!</p>
        </section>
        <section>
          <img src="img/grabli.jpg" alt="">
           <aside class="notes">
            Женщина с граблями Казимир Малевич 1932  Третьяковская галлерея
           </aside>
        </section>
        <section>
              <h2>Чем чаще, тем меньше проблем</h2>
              <ul>
                  <li class="fragment">Меньше изменений &mdash; меньше ошибок</li>
                  <li class="fragment">Вы всегда в контексте</li>
                  <li class="fragment">Отделу тестирования не нужно тратить много времени</li>
                  <li class="fragment">Бизнес не заметит подвоха</li>
              </ul>
          </section>
          <section>
            <h2>Часто &mdash; тоже плохо</h2>
          </section>
          <section>
              <img alt="" src="img/5.jpg"/>
          </section>
          <section>
              Как быть, если нужен большой рефакторинг?
          </section>
          <section>
              &mdash; Большой рефакторинг можно заменить на маленький
          </section>
          <section>
              <h2>Правило туриста СССР</h2>
              <p data-fragment-index="0">полянку нужно оставить чище, чем она была</p>
          </section>
          <section>
            <p>
              &mdash; Давайте договоримся приводить в порядок код постепенно!
            </p>
            <p class="fragment">
              &mdash; Настроим статическую проверку код и внедрим ревью изменений!
            </p>
            <p class="fragment">
              &mdash; Будем выделять на это 10% времени и рефакторить
            </p>
          </section>
          <section data-background-image="img/4.gif" data-background-color="#322F26" >
              <aside class="notes">
                  <p>
                      Обязательно найдется разработчик, который забьет на рефакторинг первым
                  </p>
              </aside>
          </section>
          <section>
              <h2>Решение - ДТПП</h2>
              <p class="fragment">
                  Добрые туристы по принуждению!
              </p>
          </section>
          <section >
              <h4>Git hooks + статический анализ кода</h4>
              <img alt="" src="img/8.png" style="border: none; box-shadow: none"/>
              <aside class="notes">
                  <p>
                      git hooks + jshint + gulp
                  </p>
              </aside>
          </section>
          <section>
              Через полгода кодовую базу будет не узнать
          </section>

          <section id="tourist-fail" data-background-video="img/css4.mp4" >
              <style>
               #tourist-fail p{
                   background: rgba(255,255,255,0.9);
                   padding: 1em;
               }
              </style>

              <p class="fragment">
                  &mdash; Нет времени объяснять...
              </p>
              <p class="fragment">
                  &mdash; Нужен коммит
              </p>
              <p class="fragment">
                  &mdash; Мы не можем разрабатывать, все время срабатывают линтеры
              </p>
              <aside class="notes">
                  А что если постепенный рефакторинг не помогает
              </aside>
          </section>
          <section>
            <h2>Тренировка и еще раз тренировка!</h2>
          </section>
          <section>
            <h2>Рефакторинг, когда поздно пить Боржоми</h2>
            <img src="img/borjomi_1.jpg" alt="">
          </section>
          <section>
              <h2>Два подхода к рефакторингу</h2>
              <ol>
                  <li class="fragment">Код как текст</li>
                  <li class="fragment">Код как код</li>
              </ol>
          </section>
          <section>
              <h2>Поиск, консоль и регулярные выражения</h2>
              <ul>
                  <li class="fragment">Работа с путями</li>
                  <li class="fragment">Работа со стилями</li>
                  <li class="fragment">Небольшие изменения в коде</li>
              </ul>
          </section>
          <section>
              <h2>Консоль</h2>
              <p>
                  awk, sed, rm, mv, touch, ag, grep, ack, cat, pbcopy, pbpaste...
              </p>
          </section>
          <section>
            <h2>Сравнение скорости поиска</h2>
            <ul>
              <li>
                Поиск с IDE - 20сек
              </li>
              <li class="fragment">
                Grep - CTRL + C после минуты
              </li>
              <li class="fragment">Ack - 24сек</li>
              <li class="fragment">Ripgrep - 5 сек, второй поиск 200 мс (https://goo.gl/5MgKNC)</li>
            </ul>
          </section>
          <section>
            <h2>Нестандартные задачи</h2>
            <p>find . -name '*.js' | sed 's/\(.*\)/require("\1");/g'</p>
          </section>
          <section>
            <h2>Формируем index.js</h2>
            <img src="img/shelltrick.png" alt="">
          </section>
          <section>
            <img src="img/bash.png" alt="">
          </section>
          <section>
                <h2>Все предусмотрели?!</h2>
                <img src="img/bg.png" alt="">
          </section>
          <section>
              <h2>Отладчик регулярных выражений</h2>
              <img alt="" src="img/11.png"/>
          </section>
          <section>
            <img src="img/htmlreg.png" alt="">
          </section>
          <section>
              <h2>
                  Используйте статические анализаторы
              </h2>
              <p class="fragment">
                  Единообразный код проще рефакторить
              </p>
              <p class="fragment" >
                  eslint, jshint, csslint и еще много много других
              </p>
          </section>
          <section>
            <h2>
            <a href="https://stylelint.io/">stylelint.io</a>
            </h2>
            <ul>
              <li class="frament">Поддержка LESS, SCSS, SASS</li>
              <li class="frament">Плагины</li>
            </ul>
          </section>
          <section>
            <img src="img/grabli.jpg" alt="">
          </section>
          <section data-background-image="img/errorscreen.png"> </section>

          <section>
              <h2>Встроенные средства для рефакторинга</h2>
              <ul>
                  <li class="fragment">Поиск и замена</li>
                  <li class="fragment">Переименование</li>
                  <li class="fragment">Перетаскивание мышкой файлов и папок</li>
              </ul>
          </section>
          <section>
              <h2>Поиск и замена в IDE</h2>
              <img alt="" src="img/10.png" />
          </section>
          <section>
              <h2>Поиск и замена в IDE</h2>
              <img alt="" src="img/9.png" />
          </section>
          <section id="ide2" data-background-video="img/csside2.mov"></section>
          <section>
              <h2>Иногда, в бою, это почти всегда не работает</h2>
          </section>
          <section id="ide3" data-background-video="img/csside3.mov"></section>
          <section  data-background-video="img/ide.mp4"></section>
          <section data-background-image="img/idea.png"></section>
          <section>
            <h2>Можно положить настройки от IDEA в репо</h2>
            <p>
               <a href="https://www.gitignore.io/api/Intellij">https://www.gitignore.io/api/Intellij</a>
            </p>
            <p>
            .idea/inspectionProfiles
            </p>
          </section>



            <section>
              <h2>
                  Рефакторинг на основе AST
              </h2>
              <p class="fragment">(Абстрактное синтаксическое дерево)</p>
          </section>
          <section>
            <img src="img/ast.png" alt="">
            <aside class="notes">
              в информатике конечное помеченное ориентированное дерево, в котором внутренние вершины сопоставлены (помечены) с операторами языка программирования, а листья — с соответствующими операндами.

              Синтаксические деревья используются в парсерах для промежуточного представления
            </aside>
          </section>
          <section>
            <img src="img/ast2.png" alt="">
          </section>
          <section>
            <img src="img/ast3.png" alt="">
          </section>
          <section>
              <h2>grasp</h2>
              <p>
                  npm install -g grasp
              </p>
              <p>
                  <a href="http://www.graspjs.com/">http://www.graspjs.com/</a>
              </p>
          </section>
          <section>
              <h3>
              CSS подобный синтаксис
              </h3>
              <pre style="font-size: 20px" class="fragment"><code data-trim data-noescape>
$ grasp 'if.test[op=&&]' a.js

  2:   if (x && f(x)) { return x; }
  5:   if (xs.length && ys.length) {
  10:  if (x == 3 && list[x]) {
              </code></pre>
              <h3 class="fragment">
                  Поиск по шаблонам
              </h3>
              <pre class="fragment"><code data-trim data-noescape>
$ grasp -e 'return __ + __' b.js

  3:  if (x < 2) { return x + 2; }
  13:      return '>>' + str.slice(2);
  15:  return f(z) + x;
              </code></pre>
          </section>
          <section>
              <h2>Рефакторинг</h2>
              <pre class="fragment"><code style="font-size: 150%" data-trim data-noescape>
$ cat c.js
  f(x < y, x == z);
$ grasp bi --replace '{{.r}}+{{.l}}' c.js
  f(y+x, z+x);</code></pre>
              <p class="fragment">
                  Есть  API
              </p>
          </section>
          <section>
              <h2>jscodeshift</h2>
              <p>
                  jscodeshift is a toolkit for running codemods over multiple JS files.
              </p>
              <a href="https://github.com/facebook/jscodeshift">https://github.com/facebook/jscodeshift</a>
          </section>
          <section>
              <h2>Codemods</h2>
              <pre class="fragment"><code data-trim data-noescape>
/**
 * This replaces every occurence of variable "foo".
 */
module.exports = function(fileInfo, api) {
  return api.jscodeshift(fileInfo.source)
    .findVariableDeclarators('foo')
    .renameTo('bar')
    .toSource();
}
              </code></pre>
          </section>
          <section>
              <h2>Готовый сборник рецептов</h2>
              <p>
              <a href="https://github.com/cpojer/js-codemo">https://github.com/cpojer/js-codemod</a>
              </p>
              <ul class="fragment">
                  <li>var в const или let.</li>
                  <li>Обратные вызовы в cтрелочные функции</li>
                  <li>Строки в шаблоны</li>
              </ul>
          </section>
          <section>
              Стили тоже можно рефакторить в AST режиме
          </section>
          <section>
            <h2>Мой опыт</h2>
            <p>Stylus → Грязный CSS → Чистый CSS + vars → LESS</p>
          </section>
          <section>
              <h2>POSTCSS + plugins</h2>
              <ul>
                  <li class="fragment">Убрать дублирование стилей</li>
                  <li class="fragment">Уменьшить разброс цветов</li>
                  <li class="fragment">Убрать префиксы</li>
                  <li class="fragment">Выделить новые переменные</li>
              </ul>
              <p class="fragment">
                POSTCSS в сборку
              </p>
          </section>
          <section  data-background-video="img/panic.mp4"></section>
          <section>
            <img src="img/grabli.jpg" alt="">
          </section>

          <section>
              <h2>Мердж изменений &mdash; очень больно</h2>
          </section>
          <section>
              <h2>Gulp</h2>
              <pre class="fragment"><code data-trim data-noescape>
gulp.task('refactor', function () {
  return gulp.src('folder/**/*.js')
    .pipe(RefactoringPlugin())
    .pipe(gulp.dest('./'))
})
              </code></pre>
          </section>
          <section>
              <p>
                  Если что-то пошло не так, то
              <pre class="fragment"><code data-trim data-noescape>
$ git reset --hard
$ git merge origin/master
$ gulp refactor
              </code></pre>
              </p>
          </section>
          <section  data-background-video="img/panic.mp4"></section>
          <section>
            <img src="img/grabli.jpg" alt="">
          </section>

          <section>
            <h2>Баги не всегда очевидны</h2>
        </section>
        <section>
                <img src="img/sc1.png" alt="">
        </section>
        <section>
                <img src="img/sc2.png" alt="">
        </section>
        <section>
                <img src="img/result.png" alt="">
        </section>
        <section>
            <h2>А вы вообще уверены что это баг?!</h2>
        </section>
        <section>
        <p>&mdash; Мы подумали и решили, что красный цвет лучше!</p>
             <img src="img/cruel.jpg" alt="">
        </section>
        <section>
          <h2>Иногда менеджеры должны быть в курсе дел</h2>
        </section>
        <section  data-background-video="img/haha.mp4"></section>

          <section>
              Спасибо за внимание!
          </section>
          <section>
            Вопросы!
          </section>
      </div>
		</div>

		<script src="lib/js/head.min.js"></script>
		<script src="js/reveal.js"></script>

		<script>
			// More info https://github.com/hakimel/reveal.js#configuration
			Reveal.initialize({
				history: true,

				// More info https://github.com/hakimel/reveal.js#dependencies
				dependencies: [
					{ src: 'plugin/markdown/marked.js' },
					{ src: 'plugin/markdown/markdown.js' },
					{ src: 'plugin/notes/notes.js', async: true },
					{ src: 'plugin/highlight/highlight.js', async: true, callback: function() { hljs.initHighlightingOnLoad(); } }
				]
			});
		</script>
	</body>
</html>
